{% extends "base.html" %}
{% block content %}

<div class="d-flex align-items-center mb-3">
  <a href="{{ url_for('lista_turmas') }}" class="btn btn-outline-secondary me-2"><i class="bi bi-arrow-left"></i></a>
  <h2 class="mb-0">Atividade por turma (aluno específico)</h2>
</div>
<hr>

{% if step == 1 %}
  <div class="card border-0 shadow-sm">
    <div class="card-body">
      <form method="post" class="row g-3" id="form-step1">
        <div class="col-12 col-md-6">
          <label class="form-label">Turma</label>
          <select name="turma_id" id="turma_id" class="form-select" required>
            <option value="">— Selecione —</option>
            {% for t in turmas %}
              <option value="{{ t.id }}">
                {{ t.escola.nome }} • {{ t.serie.nome }}{% if t.nome %} • {{ t.nome }}{% endif %}{% if t.turno %} • {{ t.turno }}{% endif %}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Aluno da turma</label>
          <select name="aluno_id" id="aluno_id" class="form-select" required disabled>
            <option value="">— selecione a turma primeiro —</option>
          </select>
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label">Data</label>
          <input type="date" name="data" class="form-control" value="{{ data }}" required>
        </div>

        <div class="col-12">
          <label class="form-label">Conteúdo (o que estudou)</label>
          <textarea name="conteudo" class="form-control" rows="3" required></textarea>
        </div>

        <div class="col-12">
          <label class="form-label">Observação do professor</label>
          <textarea name="observacao" class="form-control" rows="3" required></textarea>
        </div>

        <div class="col-12 d-flex gap-2">
          <button class="btn btn-primary"><i class="bi bi-check2-circle"></i> Registrar</button>
          <a href="{{ url_for('lista_turmas') }}" class="btn btn-outline-secondary">Cancelar</a>
        </div>
      </form>
    </div>
  </div>

  <script>
    const turmaSel = document.getElementById('turma_id');
    const alunoSel = document.getElementById('aluno_id');

    turmaSel.addEventListener('change', async () => {
      alunoSel.innerHTML = '<option>Carregando…</option>';
      alunoSel.disabled = true;
      const id = turmaSel.value;
      if (!id) {
        alunoSel.innerHTML = '<option>— selecione a turma primeiro —</option>';
        return;
      }
      const res = await fetch(`/turmas/${id}/alunos.json`);
      const data = await res.json();
      alunoSel.innerHTML = '<option value="">— Selecione —</option>';
      data.forEach(a => {
        const opt = document.createElement('option');
        opt.value = a.id; opt.textContent = a.nome;
        alunoSel.appendChild(opt);
      });
      alunoSel.disabled = false;
    });
  </script>

{% elif step == 2 %}
  <div class="alert alert-success">Atividade registrada/atualizada com sucesso.</div>

  <div class="card border-0 shadow-sm">
    <div class="card-body">
      <h5 class="card-title">Ações</h5>
      <div class="d-flex gap-2">
        {% if whatsapp %}
          <a class="btn btn-success" target="_blank" href="{{ whatsapp }}"><i class="bi bi-whatsapp"></i> Enviar WhatsApp</a>
        {% else %}
          <span class="text-muted">Sem telefone para WhatsApp.</span>
        {% endif %}
        <a class="btn btn-outline-primary" href="{{ url_for('atividade_por_turma_aluno') }}">Lançar outra</a>
        <a class="btn btn-outline-secondary" href="{{ url_for('lista_atividades') }}">Ver lista de atividades</a>
      </div>
    </div>
  </div>
{% endif %}

{% endblock %}
