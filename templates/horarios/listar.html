{% extends "base.html" %}
{% block title %}Horários{% endblock %}

{% block content %}
<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Horários</h3>

    {% if current_user.is_diretoria() %}
      <a href="{{ url_for('horarios_novo') }}" class="btn btn-primary">
        Novo Horário
      </a>
    {% endif %}
  </div>

  <!-- Tabela (mantém a listagem normal) -->
  <div class="card mb-4">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-dark align-middle mb-0">
          <thead>
            <tr>
              <th style="width:220px">Horário</th>
              <th class="text-center" style="width:180px">Qtd. Alunos</th>
              {% if current_user.is_diretoria() %}
                <th class="text-end" style="width:220px">Ações</th>
              {% endif %}
            </tr>
          </thead>
          <tbody>
            {% for h in items %}
              {% set lista = alunos_por_horario.get(h.id, []) %}
              <tr>
                <td class="fw-semibold">{{ h.hora_inicio }} - {{ h.hora_fim }}</td>

                <td class="text-center">
                  <span class="badge">{{ lista|length }}</span>
                </td>

                {% if current_user.is_diretoria() %}
                  <td class="text-end">
                    <form method="post" action="{{ url_for('horarios_editar', id=h.id) }}" class="d-inline">
                      <input class="form-control d-inline-block" style="width:110px" name="hora_inicio" value="{{ h.hora_inicio }}">
                      <input class="form-control d-inline-block" style="width:110px" name="hora_fim" value="{{ h.hora_fim }}">
                      <button class="btn btn-outline-light btn-sm">Salvar</button>
                    </form>

                    <form method="post" action="{{ url_for('horarios_excluir', id=h.id) }}" class="d-inline"
                          onsubmit="return confirm('Excluir este horário?');">
                      <button class="btn btn-outline-danger btn-sm">Excluir</button>
                    </form>
                  </td>
                {% endif %}
              </tr>
            {% else %}
              <tr>
                <td colspan="{{ 3 if current_user.is_diretoria() else 2 }}" class="text-center text-secondary py-4">
                  Nenhum horário cadastrado.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ✅ QUADROS / CARDS com alunos por horário -->
  <h5 class="mb-3">Alunos por horário</h5>

  <div class="row g-3">
    {% for h in items %}
      {% set lista = alunos_por_horario.get(h.id, []) %}
      <div class="col-12 col-md-6 col-lg-4">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="fw-semibold">{{ h.hora_inicio }} - {{ h.hora_fim }}</div>
              <span class="badge">{{ lista|length }}</span>
            </div>

            {% if lista %}
              <div class="list-group list-group-flush">
                {% for a in lista %}
                  <div class="list-group-item bg-transparent text-light border-top-0 border-start-0 border-end-0 border-bottom"
                       style="border-color:#1f2937 !important;">
                    <div class="fw-semibold">{{ a.nome }}</div>
                    <div class="small text-secondary">
                      {% if a.serie %}{{ a.serie.nome }}{% else %}—{% endif %}
                      {% if a.escola %} • {{ a.escola.nome }}{% endif %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="text-secondary">Nenhum aluno neste horário.</div>
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}

    {% if alunos_sem_horario and alunos_sem_horario|length > 0 %}
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="fw-semibold">Sem horário definido</div>
              <span class="badge">{{ alunos_sem_horario|length }}</span>
            </div>

            <div class="row g-2">
              {% for a in alunos_sem_horario %}
                <div class="col-12 col-md-6 col-lg-4">
                  <div class="p-2 rounded" style="background:#0b1220; border:1px solid #1f2937;">
                    <div class="fw-semibold">{{ a.nome }}</div>
                    <div class="small text-secondary">
                      {% if a.serie %}{{ a.serie.nome }}{% else %}—{% endif %}
                      {% if a.escola %} • {{ a.escola.nome }}{% endif %}
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>

          </div>
        </div>
      </div>
    {% endif %}
  </div>

</div>
{% endblock %}
