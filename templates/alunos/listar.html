{% extends 'base.html' %}
{% block title %}Alunos{% endblock %}

{% block content %}

{# --------- Resolve endpoints com fallback (evita BuildError) --------- #}
{% set list_endpoint =
      'alunos_listar' if (has_endpoint and 'alunos_listar' in has_endpoint)
      else ('alunos.listar' if (has_endpoint and 'alunos.listar' in has_endpoint) else None) %}

{% set novo_endpoint =
      'alunos_novo' if (has_endpoint and 'alunos_novo' in has_endpoint)
      else ('alunos.novo' if (has_endpoint and 'alunos.novo' in has_endpoint) else None) %}

{% set editar_endpoint =
      'alunos_editar' if (has_endpoint and 'alunos_editar' in has_endpoint)
      else ('alunos.editar' if (has_endpoint and 'alunos.editar' in has_endpoint) else None) %}

{% set excluir_endpoint =
      'alunos_excluir' if (has_endpoint and 'alunos_excluir' in has_endpoint)
      else ('alunos.excluir' if (has_endpoint and 'alunos.excluir' in has_endpoint) else None) %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h4 class="mb-0">Alunos</h4>
    <small class="text-secondary">Gerencie alunos: cadastro, edição, exclusão e busca.</small>
  </div>

  <div class="d-flex gap-2 align-items-center">
    {# Formulário de busca: só exibe se houver endpoint de listagem #}
    {% if list_endpoint %}
      <form class="d-flex" method="get" action="{{ url_for(list_endpoint) }}">
        <input
          class="form-control form-control-sm"
          type="text"
          name="q"
          value="{{ request.args.get('q','') }}"
          placeholder="Buscar por nome, escola..."
          autocomplete="off"
        >
        <button class="btn btn-sm btn-outline-light ms-2">Buscar</button>
      </form>
    {% endif %}

    {# Botão visível APENAS para Diretoria e se existir endpoint de novo aluno #}
    {% if is_diretoria and novo_endpoint %}
      <a class="btn btn-light btn-sm" href="{{ url_for(novo_endpoint) }}">
        Novo aluno
      </a>
    {% endif %}
  </div>
</div>

<div class="card card-glass p-3">
  <div class="table-responsive">
    <table class="table table-dark table-hover align-middle mb-0">
      <thead>
        <tr>
          <th style="width:64px">Foto</th>
          <th>Nome</th>
          <th class="text-nowrap">Escola</th>
          <th class="text-nowrap">Série</th>
          <th class="text-nowrap">Horário</th>
          <th class="text-nowrap">Telefone</th>
          <th style="width:200px" class="text-end">Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for a in items %}
        <tr>
          <td>
            {% if a.foto_path %}
              <img src="{{ url_for('uploads', filename=a.foto_path) }}" class="avatar-sm" alt="foto">
            {% else %}
              <div class="avatar-sm d-flex align-items-center justify-content-center bg-secondary">—</div>
            {% endif %}
          </td>

          <td class="fw-semibold">{{ a.nome }}</td>
          <td>{{ a.escola.nome if a.escola else '-' }}</td>
          <td>{{ a.serie.nome if a.serie else '-' }}</td>

          <td>
            {% if a.horario %}
              {{ a.horario.hora_inicio }}–{{ a.horario.hora_fim }}
            {% else %}-{% endif %}
          </td>

          <td>
            {% set tel = (a.telefone_cel or '') ~ (' / ' ~ a.telefone_fixo if a.telefone_fixo else '') %}
            {{ tel if tel|trim else '-' }}
          </td>

          <td class="text-end">
            {% if editar_endpoint %}
              <a class="btn btn-sm btn-outline-light" href="{{ url_for(editar_endpoint, id=a.id) }}">Editar</a>
            {% endif %}

            {% if excluir_endpoint and is_diretoria %}
              <form class="d-inline" method="post" action="{{ url_for(excluir_endpoint, id=a.id) }}"
                    onsubmit="return confirm('Excluir este aluno?')">
                <button class="btn btn-sm btn-outline-danger">Excluir</button>
              </form>
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="7" class="text-center text-secondary py-4">
            Nenhum aluno encontrado.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% if pagination %}
<nav class="mt-3">
  <ul class="pagination pagination-sm mb-0">
    <li class="page-item {% if not pagination.prev_url %}disabled{% endif %}">
      <a class="page-link" href="{{ pagination.prev_url or '#' }}">Anterior</a>
    </li>
    <li class="page-item disabled">
      <span class="page-link">Página {{ pagination.page }} de {{ pagination.pages }}</span>
    </li>
    <li class="page-item {% if not pagination.next_url %}disabled{% endif %}">
      <a class="page-link" href="{{ pagination.next_url or '#' }}">Próxima</a>
    </li>
  </ul>
</nav>
{% endif %}
{% endblock %}
