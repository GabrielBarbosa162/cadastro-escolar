{% extends 'base.html' %}
{% block title %}{{ 'Editar Aluno' if aluno else 'Novo Aluno' }}{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-0">{{ 'Editar Aluno' if aluno else 'Novo Aluno' }}</h2>
  </div>
  <div>
    <a href="{{ url_for('alunos_list') }}" class="btn btn-outline-light btn-sm">
      Voltar
    </a>
  </div>
</div>

<form method="post" enctype="multipart/form-data" class="row g-4">

  <!-- ===================== IDENTIFICAÇÃO ===================== -->
  <div class="col-12">
    <div class="card bg-dark text-light border-secondary shadow-sm">
      <div class="card-header border-secondary">
        <h5 class="mb-0">Identificação</h5>
      </div>
      <div class="card-body row g-3">
        <div class="col-md-6">
          <label class="form-label">Nome completo</label>
          <input type="text" name="nome" class="form-control"
                 value="{{ aluno.nome if aluno else '' }}" required>
        </div>

        <div class="col-md-3">
          <label class="form-label">Naturalidade</label>
          <input type="text" name="naturalidade" class="form-control"
                 value="{{ aluno.naturalidade if aluno else '' }}">
        </div>

        <div class="col-md-3">
          <label class="form-label">Nacionalidade</label>
          <input type="text" name="nacionalidade" class="form-control"
                 value="{{ aluno.nacionalidade if aluno else '' }}">
        </div>

        <div class="col-md-3">
          <label class="form-label">Data de nascimento</label>
          <input type="date" name="data_nascimento" class="form-control"
                 value="{{ aluno.data_nascimento.strftime('%Y-%m-%d') if aluno and aluno.data_nascimento else '' }}">
        </div>

        <div class="col-md-2">
          <label class="form-label">Idade (anos)</label>
          <input type="number" name="idade" class="form-control"
                 value="{{ aluno.idade if aluno and aluno.idade else '' }}">
        </div>

        <div class="col-md-3">
          <label class="form-label">Sexo</label>
          <select name="sexo" class="form-select">
            <option value="">Selecione</option>
            <option value="M" {% if aluno and aluno.sexo == 'M' %}selected{% endif %}>Masculino</option>
            <option value="F" {% if aluno and aluno.sexo == 'F' %}selected{% endif %}>Feminino</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================== FILIAÇÃO E CONTATOS ===================== -->
  <div class="col-12">
    <div class="card bg-dark text-light border-secondary shadow-sm">
      <div class="card-header border-secondary">
        <h5 class="mb-0">Filiação e Contatos</h5>
      </div>
      <div class="card-body row g-3">
        <div class="col-md-6">
          <label class="form-label">Nome do Pai</label>
          <input type="text" name="nome_pai" class="form-control"
                 value="{{ aluno.nome_pai if aluno else '' }}">
        </div>

        <div class="col-md-6">
          <label class="form-label">Nome da Mãe</label>
          <input type="text" name="nome_mae" class="form-control"
                 value="{{ aluno.nome_mae if aluno else '' }}">
        </div>

        <div class="col-md-6">
          <label class="form-label">Endereço</label>
          <input type="text" name="endereco" class="form-control"
                 value="{{ aluno.endereco if aluno else '' }}">
        </div>

        <div class="col-md-2">
          <label class="form-label">Número</label>
          <input type="text" name="numero" class="form-control"
                 value="{{ aluno.numero if aluno else '' }}">
        </div>

        <div class="col-md-4">
          <label class="form-label">Bairro</label>
          <input type="text" name="bairro" class="form-control"
                 value="{{ aluno.bairro if aluno else '' }}">
        </div>

        <div class="col-md-3">
          <label class="form-label">Celular</label>
          <input type="text" name="telefone_cel" class="form-control"
                 value="{{ aluno.telefone_cel if aluno else '' }}">
        </div>

        <div class="col-md-3">
          <label class="form-label">Fixo</label>
          <input type="text" name="telefone_fixo" class="form-control"
                 value="{{ aluno.telefone_fixo if aluno else '' }}">
        </div>
      </div>
    </div>
  </div>

  <!-- ===================== VÍNCULO ESCOLAR ===================== -->
  <div class="col-12">
    <div class="card bg-dark text-light border-secondary shadow-sm">
      <div class="card-header border-secondary">
        <h5 class="mb-0">Vínculo Escolar</h5>
      </div>
      <div class="card-body row g-3">
        <div class="col-md-4">
          <label class="form-label">Escola</label>
          <select name="escola_id" class="form-select">
            <option value="">Selecione</option>
            {% for e in escolas %}
              <option value="{{ e.id }}"
                {% if aluno and aluno.escola_id == e.id %}selected{% endif %}>
                {{ e.nome }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-4">
          <label class="form-label">Série</label>
          <select name="serie_id" class="form-select">
            <option value="">Selecione</option>
            {% for s in series %}
              <option value="{{ s.id }}"
                {% if aluno and aluno.serie_id == s.id %}selected{% endif %}>
                {{ s.nome }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-4">
          <label class="form-label">Horário (tabela)</label>
          <select name="horario_id" class="form-select">
            <option value="">Selecione</option>
            {% for h in horarios %}
              <option value="{{ h.id }}"
                {% if aluno and aluno.horario_id == h.id %}selected{% endif %}>
                {{ h.hora_inicio }} — {{ h.hora_fim }}
              </option>
            {% endfor %}
          </select>
          <small class="text-muted d-block mt-1">
            Selecione apenas pela tabela de horários cadastrada.
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================== CONDIÇÕES E OBSERVAÇÕES ===================== -->
  <div class="col-12">
    <div class="card bg-dark text-light border-secondary shadow-sm">
      <div class="card-header border-secondary">
        <h5 class="mb-0">Condições e Observações</h5>
      </div>
      <div class="card-body row g-3">

        <div class="col-md-6">
          <label class="form-label d-block">Possui alguma dificuldade?</label>
          <div class="btn-group" role="group">
            <input type="radio" class="btn-check" name="tem_dificuldade"
                   id="dif_sim" value="on"
                   {% if aluno and aluno.tem_dificuldade %}checked{% endif %}>
            <label class="btn btn-outline-light btn-sm" for="dif_sim">Sim</label>

            <input type="radio" class="btn-check" name="tem_dificuldade"
                   id="dif_nao" value=""
                   {% if aluno and not aluno.tem_dificuldade %}checked{% endif %}>
            <label class="btn btn-outline-light btn-sm" for="dif_nao">Não</label>
          </div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Qual?</label>
          <input type="text" name="qual_dificuldade" class="form-control"
                 value="{{ aluno.qual_dificuldade if aluno else '' }}">
        </div>

        <div class="col-md-6">
          <label class="form-label d-block">Toma medicamento controlado?</label>
          <div class="btn-group" role="group">
            <input type="radio" class="btn-check" name="toma_medicamento"
                   id="med_sim" value="on"
                   {% if aluno and aluno.toma_medicamento %}checked{% endif %}>
            <label class="btn btn-outline-light btn-sm" for="med_sim">Sim</label>

            <input type="radio" class="btn-check" name="toma_medicamento"
                   id="med_nao" value=""
                   {% if aluno and not aluno.toma_medicamento %}checked{% endif %}>
            <label class="btn btn-outline-light btn-sm" for="med_nao">Não</label>
          </div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Qual?</label>
          <input type="text" name="qual_medicamento" class="form-control"
                 value="{{ aluno.qual_medicamento if aluno else '' }}">
        </div>

        <div class="col-md-3">
          <label class="form-label">Início das aulas</label>
          <input type="date" name="inicio_aulas" class="form-control"
                 value="{{ aluno.inicio_aulas.strftime('%Y-%m-%d') if aluno and aluno.inicio_aulas else '' }}">
        </div>

        <div class="col-md-9">
          <label class="form-label d-block">Mensalidade</label>

          {% set mensal = aluno.mensalidade_opcao if aluno and aluno.mensalidade_opcao else '' %}

          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="mensalidade_opcao"
                   id="mensal_pre" value="Pré 1 a 5 ano - 170,00R$"
                   {% if 'Pré 1' in mensal or '170,00' in mensal %}checked{% endif %}>
            <label class="form-check-label" for="mensal_pre">
              Pré 1 á 5 ano — R$ 170,00
            </label>
          </div>

          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="mensalidade_opcao"
                   id="mensal_6a7" value="6 ano a 7 ano - 180,00R$"
                   {% if '6 ano' in mensal or '180,00' in mensal %}checked{% endif %}>
            <label class="form-check-label" for="mensal_6a7">
              6º ano á 7º ano — R$ 180,00
            </label>
          </div>

          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="mensalidade_opcao"
                   id="mensal_8a9" value="8 ano a 9 ano - 190,00R$"
                   {% if '8 ano' in mensal or '190,00' in mensal %}checked{% endif %}>
            <label class="form-check-label" for="mensal_8a9">
              8º ano á 9º ano — R$ 190,00
            </label>
          </div>

          <small class="text-muted d-block mt-1">
            Selecione apenas uma opção.
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================== FOTO (OPCIONAL) ===================== -->
  <div class="col-12">
    <div class="card bg-dark text-light border-secondary shadow-sm">
      <div class="card-header border-secondary">
        <h5 class="mb-0">Foto (opcional)</h5>
      </div>
      <div class="card-body row g-3">
        <div class="col-md-8">
          <label class="form-label">Foto do aluno</label>
          <input type="file" name="foto" class="form-control" accept="image/*">
          {% if aluno and aluno.foto_path %}
            <input type="hidden" name="foto_path" value="{{ aluno.foto_path }}">
            <div class="mt-3 d-flex align-items-center gap-3">
              <span class="text-muted">Foto atual:</span>
              <img src="{{ url_for('static', filename=aluno.foto_path) }}"
                   alt="Foto atual"
                   style="width:72px; height:72px; border-radius:50%; object-fit:cover; border:1px solid #4b5563;">
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- ===================== BOTÕES ===================== -->
  <div class="col-12 d-flex justify-content-start gap-2 mt-2 mb-4">
    <button type="submit" class="btn btn-success">
      Salvar
    </button>
    <a href="{{ url_for('alunos_list') }}" class="btn btn-secondary">
      Voltar
    </a>
  </div>

</form>

{% endblock %}
