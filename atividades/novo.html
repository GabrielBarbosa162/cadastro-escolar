{% extends 'base.html' %}
{% block title %}Lançar atividade{% endblock %}
{% block content %}
<div class="container py-4">
  <h3 class="mb-3">Lançar atividade</h3>
  <form method="post" class="row g-3" autocomplete="off">
    <div class="col-12 col-md-6">
      <label class="form-label">Nome do aluno</label>
      <input type="text" id="buscaAluno" class="form-control" placeholder="Digite para buscar...">
      <small class="text-secondary">Comece a digitar para filtrar. Depois selecione abaixo.</small>
      <select class="form-select mt-2" name="aluno_id" id="selectAluno" required>
        <option value="">Selecione…</option>
        {% for a in alunos %}
          <option value="{{ a.id }}">{{ a.nome }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-12 col-md-3">
      <label class="form-label">Data da atividade</label>
      <input name="data_atividade" class="form-control" placeholder="dd/mm/aaaa">
    </div>

    <div class="col-12">
      <label class="form-label">Conteúdo estudado</label>
      <textarea name="conteudo" class="form-control" rows="3"></textarea>
    </div>

    <div class="col-12">
      <label class="form-label">Observação</label>
      <textarea name="observacao" class="form-control" rows="2"></textarea>
    </div>

    <div class="col-12 text-end">
      <a class="btn btn-outline-light" href="{{ url_for('atividades_listar') }}">Cancelar</a>
      <button class="btn btn-light">Salvar</button>
    </div>
  </form>
</div>

<script>
  const busca = document.getElementById('buscaAluno');
  const select = document.getElementById('selectAluno');

  let lastQuery = '';
  async function fetchAlunos(q) {
    const url = q ? `/alunos/search?q=${encodeURIComponent(q)}` : '/alunos/search';
    const res = await fetch(url);
    return await res.json();
  }

  async function updateOptions(q) {
    const data = await fetchAlunos(q);
    const selected = select.value;
    select.innerHTML = '<option value="">Selecione…</option>';
    for (const a of data) {
      const opt = document.createElement('option');
      opt.value = a.id;
      opt.textContent = a.nome;
      if (String(a.id) === selected) opt.selected = true;
      select.appendChild(opt);
    }
  }

  busca.addEventListener('input', async (e) => {
    const q = e.target.value.trim();
    if (q === lastQuery) return;
    lastQuery = q;
    await updateOptions(q);
  });
</script>
{% endblock %}
